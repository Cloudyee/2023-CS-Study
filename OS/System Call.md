# 목차
1. 사용자 모드와 커널 모드
  1. 사용자 모드
  2. 커널 모드
  3. 특권 명령
3. 시스템 호출
  1. 개념
  2. 왜 시스템 호출이 필요한가?
    1. 함수 호출
    2. 시스템 호출
    3. 
  4. 작동 방식
4. 시스템 호출 유형
5. 예상 면접 질문
<br>
<br>

# 사용자 모드와 커널 모드
- 여기서 mode란 CPU의 실행 모드를 의미한다.
- 시스템 호출 또는 인터럽트가 발생했을 때 사용자 모드에서 커널 모드로 전환이 일어난다.
<br>
<div align='center'>   
    <img src="img/system call_1.png" width="600px">
</div>

## 사용자 모드
- 응용프로그램의 실행을 시작할 때 설정되는 CPU의 모드이다.
- 사용자 공간(user space)의 메모리만 액세스가 가능하며, 커널 공간의 메모리는 접근할 수 없다.
- 만일 CPU가 사용자 모드에서 사용자 프로그램을 실행하던 중 커널 공간의 메모리 번지를 접근하는 경우, 시스템에서는 예외가 발생하여 사용자 프로그램을 바로 종료시킨다.
- (응용프로그램의 코드에서는) 어떤 하드웨어도, 다른 프로그램에서 할당된 메모리도 접근할 수 없다.
- 특권 명령어로 불리는 특별한 기계 명령어를 실행할 수 없다.
<br>

## 커널 모드
- CPU의 모든 메모리 공간을 액세스할 수 있다.
- 특권 명령어를 실행할 수 있다.
- 어떤 하드웨어도 접근하고 제어할 수 있다.
<br>
 
## 특권 명렁어
- CPU마다 특별히 설계된 기계 명령어로, 아래 작업과 같은 특별한 목적을 갖는다.
- I/O 명령어 : 하드웨어 제어 및 장치로부터의 입출력
- Halt 명령어 : CPU 작동 중지
- 인터럽트 플래그 켜고 끄기 : 인터럽트를 허용하거나 무시하도록 지시
- 타이머 설정, 컨텍스트 스위칭, 메모리 지우기, 장치 상태 테이블 수정 등

<br>
<br>


# 시스템 호출
## 개념
<div align='center'>   
    <img src="img/system call_2.png" width="600px">
</div>

- 응용프로그램에서 커널 코드(커널에 작성된 함수)를 호출하는 기법
- 운영체제와 응용프로그램 사이의 인터페이스
- 커널 기능을 응용프로그램에서 활용하는 유일한 수단
- 하드웨어 관련 작업을 하고자 하는 경우에 발생한다. (응용프로그램이 메모리가 더 필요하거나, 파일을 읽거나, 키보드 입력을 받거나, 화면에 출력하는 등)

<br>
<br>

## 왜 시스템 호출이 필요한가?
<div align='center'>   
    <img src="img/system call_3.png" width="600px">
</div>

### 함수 호출 -> 라이브러리 활용
- 응용프로그램에 사용자가 작성한 함수들과 이들에 의해 호출되는 라이브러리 함수들이 컴파일과 링크의 과정을 거쳐 하느이 실행 파일 내에 결합되어 저장된다.
- 응용프로그램이 실행될 때, 실행 파일이 사용자 메모리 공간에 로딩된다.
- 따라서 응용프로그램의 함수들과 응용프로그램에서 호출하는 라이브러리 함수들이 응용프로그램에게 할당된 메모리 공간에 공존한다.
- 응용프로그램의 함수와 라이브러리 함수 모두 커널 모드로 전환되지 않고 사용자 공간에서 사용자 모드로 실행된다.
<br>

### 시스템 호출 -> 커널 코드 호출
- 하드웨어 관련 작업을 위해서는 커널의 함수를 호출해야하는데, 응용프로그램에서는 커널 함수를 직접 호출할 수 없다.
- 응용프로그램은 시스템 호출 라이브러리에 들어 있는 함수를 통해 간접적으로 커널 함수를 호출해야한다.
- 그러나 시스템 호출 라이브러리 역시 커널 함수의 이름을 직접 알지는 못한다.
- 따라서 커널 기능마다 정해진 번호(커널 함수의 고유 ID)를 통해 커널 코드로 진입한다.
- CPU의 모드가 커널 모드로 바뀐다.

<br>

### 정리
> `응용프로그램에서는 하드웨어를 직접 엑세스 할 수 없다.`
> 사용자의 코드는 신뢰할 수 없기 때문에, 이 기능은 오직 신뢰할 수 있는 커널 코드에게만 일임된 일이다. 
> 그러므로 파일에서 데이터를 읽거나 네트워크를 이용한 통신, 디스플레이에 텍스트를 출력하거나 키보드에서 입력받는 일까지도 응용프로그램에서는 직접 할 수 없다. 
> 이들은 모두 `커널에게 일임`된 일이다. 
> 그러므로 응용프로그램인 이런 일들을 하도록 미리 작성된 커널 코드로 점프해아하는데, 
> 이 점프가 시스템 호출(System call)이다.


<br>
<br>

## 작동 방식
<div align='center'>   
    <img src="img/system call_4.png" width="600px">
</div>

- 응용 프로그램에서 read() 함수를 실행한다.
- 특권 명령어를 통해 자동으로 CPU는 사용자 모드에서 커널 모드로 바뀐다.
- 현재 CPU 상태(레지스터)를 커널에 있는 스택에 저장한다.
- CPU의 레지스터를 읽어 시스템 호출 번호를 알아낸다.
    - 사용자 모드에서 시스템 호출 라이브러리에는 커널 함수 이름이 직접적으로 알 수 없고, 커널 기능마다 정해진 번호(커널 함수의 고유 ID)를 통해 커널 코드로 진입한다.
- 시스템 호출 표로부터 커널 함수의 주소를 알아낸다.
- 커널 함수를 호출한다.
- 디스크 장치를 제어해서 파일을 읽는다.
- 커널 스택으로부터 CPU로 레지스터를 복귀시킨다.
- 시스템 호출이 끝나고 사용자 프로그램으로 돌아가기 위해 사용자 모드로 바꾼다.


<br>
<br>

# 시스템 호출 범주
- 프로세스/메모리 제어 : exit(), kill(), fork() 등
- 파일/디렉터리 관리 : open(), read(), write(), chmod() 등
- 장치 관리 : ioctl(), read(), write() 등
- 정보 관리 : time() 등
- 통신 : connect(), send() 


# 예상 면접 질문
Q. 시스템 콜에 대해 설명해주세요. <br>
<br>

Q. 함수 호출과 시스템 호출의 차이에 대해 설멍해주세요. <br>
<br>


